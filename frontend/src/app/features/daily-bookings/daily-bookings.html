@if (isLoading()) {
  <div class="h-screen flex items-center justify-center">
    <div class="text-emerald-600 text-3xl animate-pulse">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
  </div>
}
@if (!isLoading() && rooms() && bookings()) {
  <main class="overflow-hidden relative bg-slate-50 p-6 flex flex-col isolate">
    <div class="flex gap-4 mb-4 md:mb-6 items-center flex-wrap shrink-0">
      <div class="flex items-center gap-2 bg-white rounded-lg shadow-sm p-1 border border-gray-300">
        <button
          (click)="changeDate(-1)"
          class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 hover:text-emerald-600 transition-colors"
          title="Ngày trước"
        >
          <i class="fas fa-chevron-left"></i>
        </button>

        <input
          type="date"
          [ngModel]="selectedDate()"
          (ngModelChange)="onDateChange($event)"
          class="border-none p-0 text-sm font-bold text-slate-700 outline-none focus:ring-0 cursor-pointer bg-transparent w-[110px] text-center"
        />

        <button
          (click)="changeDate(1)"
          class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 hover:text-emerald-600 transition-colors"
          title="Ngày sau"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="inline-flex p-1 bg-gray-100 rounded-2xl">
        <a
          routerLink="/bookings/weekly"
          routerLinkActive="bg-white shadow-sm text-black"
          [routerLinkActiveOptions]="{ exact: true }"
          class="px-6 py-2 text-sm font-semibold text-gray-500 transition-all duration-200 rounded-xl no-underline"
        >
          Tuần
        </a>

        <a
          routerLink="/bookings/daily"
          routerLinkActive="bg-white shadow-sm text-black"
          class="px-6 py-2 text-sm font-semibold text-gray-500 transition-all duration-200 rounded-xl no-underline"
        >
          Ngày
        </a>
      </div>
      <select
        [ngModel]="selectedLocation()"
        (ngModelChange)="updateLocation($event)"
        class="border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500 cursor-pointer shadow-sm hover:border-emerald-400 transition-colors w-full sm:w-auto bg-white"
      >
        <option value="">Tất cả khu vực</option>
        @for (loc of uniqueLocations(); track loc) {
          <option [value]="loc">{{ loc }}</option>
        }
      </select>
    </div>

    <div
      class="bg-white rounded-xl shadow-lg border border-gray-200 flex-1 overflow-hidden flex flex-col"
    >
      <div class="flex-1 overflow-auto custom-scrollbar relative">
        <div class="flex sticky top-0 z-30 bg-slate-50 border-b border-gray-200 min-w-max">
          <div
            class="w-24 md:w-56 p-2 md:p-4 font-bold text-gray-500 text-[10px] md:text-xs uppercase tracking-wider border-r border-gray-200 sticky left-0 z-40 bg-slate-50 flex items-center justify-center md:justify-start"
          >
            <span class="hidden md:inline">Phòng (Rooms)</span>
            <span class="md:hidden">Phòng</span>
          </div>

          <div class="flex">
            @for (hour of timeSlots; track hour) {
              <div
                class="text-center py-4 text-[10px] md:text-xs font-bold text-gray-400 border-r border-gray-100 w-[150px] md:flex-1 md:min-w-[100px]"
              >
                {{ hour }}:00
              </div>
            }
          </div>
        </div>
        @for (room of filteredRooms(); track room.id) {
          <div
            class="flex min-w-max border-b border-gray-100 h-24 md:h-28 relative hover:bg-slate-50 transition group"
          >
            <div
              class="w-24 md:w-56 p-2 md:p-4 border-r border-emerald-500 sticky left-0 z-20 bg-white border-l-4 group-hover:bg-slate-50 transition-colors flex flex-col justify-center gap-2"
            >
              <p class="font-bold text-xs md:text-sm text-slate-800">{{ room.name }}</p>
              <p class="hidden md:block text-xs text-slate-500 mt-1">{{ room.location }}</p>

              @if (isAdmin()) {
                <div class="flex gap-2">
                  <button
                    [routerLink]="['/tablet', room.id]"
                    class="mt-2 bg-teal-400 hover:bg-teal-500 text-white text-[10px] md:text-xs py-1 px-2 rounded transition-colors w-fit cursor-pointer"
                  >
                    <i class="fa-solid fa-tablet-screen-button"></i>
                    Tablet
                  </button>
                  <button
                    [routerLink]="['/deck', room.id]"
                    class="mt-2 bg-indigo-500 hover:bg-indigo-600 text-white text-[10px] md:text-xs py-1 px-2 rounded transition-colors w-fit cursor-pointer"
                  >
                    <i class="fa-solid fa-desktop"></i>
                    Deck
                  </button>
                </div>
              }
            </div>
            <div class="flex relative">
              <div class="flex h-full">
                @for (h of timeSlots; track h) {
                  <div
                    class="border-r border-gray-100 h-full hover:bg-emerald-50/30 cursor-pointer relative w-[150px] md:flex-1 md:min-w-[100px]"
                    (click)="openModal(room.name, h + ':00')"
                  >
                    <div
                      class="absolute inset-0 flex items-center justify-center text-emerald-400 font-bold opacity-30 pointer-events-none"
                    >
                      +
                    </div>
                  </div>
                }
              </div>

              @for (b of getBookingsForRoom(room.id ?? ''); track b.id) {
                <div
                  class="group absolute top-1.5 bottom-1.5 md:top-2 md:bottom-2 rounded-md md:rounded-lg p-1 md:p-2 text-[10px] md:text-xs text-white font-bold shadow-sm cursor-pointer transition-all z-10 hover:z-30 hover:shadow-md"
                  [class]="
                    b.createdBy === currentUser()?.uid ? 'bg-emerald-500' : 'bg-rose-400 opacity-90'
                  "
                  [style.left.%]="getBookingStyle(b).left"
                  [style.width.%]="getBookingStyle(b).width"
                  (click)="$event.stopPropagation(); editBooking(b)"
                >
                  <p class="leading-tight line-clamp-3 text-wrap break-words">{{ b.title }}</p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </main>
}
@if (showModal()) {
  <app-booking-modal
    [rooms]="rooms()"
    [currentUser]="currentUser()"
    [isAdmin]="isAdmin()"
    [booking]="selectedBooking()"
    [prefillData]="newBookingData()"
    (close)="closeModal()"
    (saved)="onBookingSaved()"
  >
  </app-booking-modal>
}

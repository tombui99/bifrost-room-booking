@if (isLoading()) {
  <div class="h-screen flex items-center justify-center">
    <div class="text-emerald-600 text-3xl animate-pulse">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
  </div>
}

@if (!isLoading()) {
  <main class="bg-slate-50 flex flex-col isolate overflow-hidden relative">
    <div class="p-6 bg-white flex justify-between items-center shrink-0">
      <div class="flex items-center gap-4">
        <div
          class="flex items-center gap-2 bg-white rounded-lg shadow-sm p-1 border border-gray-300"
        >
          <button
            (click)="changeWeek(-1)"
            class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 hover:text-emerald-600 transition-colors"
          >
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="px-4 text-sm font-bold text-slate-700"
            >{{ weekDays()[0] | date: 'dd/MM' }} - {{ weekDays()[6] | date: 'dd/MM' }}</span
          >
          <button
            (click)="changeWeek(1)"
            class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 hover:text-emerald-600 transition-colors"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="inline-flex p-1 bg-gray-100 rounded-2xl">
          <a
            routerLink="/bookings/weekly"
            routerLinkActive="bg-white shadow-sm text-black"
            [routerLinkActiveOptions]="{ exact: true }"
            class="px-6 py-2 text-sm font-semibold text-gray-500 transition-all duration-200 rounded-xl no-underline"
          >
            Tuần
          </a>

          <a
            routerLink="/bookings/daily"
            routerLinkActive="bg-white shadow-sm text-black"
            class="px-6 py-2 text-sm font-semibold text-gray-500 transition-all duration-200 rounded-xl no-underline"
          >
            Ngày
          </a>
        </div>
        <select
          [ngModel]="selectedLocation()"
          (ngModelChange)="selectedLocation.set($event)"
          class="border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500 cursor-pointer shadow-sm hover:border-emerald-400 transition-colors w-full sm:w-auto bg-white"
        >
          <option value="">Tất cả khu vực</option>
          @for (loc of uniqueLocations(); track loc) {
            <option [value]="loc">{{ loc }}</option>
          }
        </select>
      </div>
    </div>

    <div class="flex-1 overflow-auto p-6">
      <div
        class="min-w-[1200px] bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col"
      >
        <!-- Header -->
        <div class="flex bg-slate-50/50 sticky top-0 z-30">
          <div class="w-20 border-r border-gray-100"></div>
          @for (day of weekDays(); track day.getTime()) {
            <div
              class="flex-1 py-4 text-center border-r border-gray-100 cursor-pointer hover:bg-emerald-100 transition"
              (click)="navigateToDailyBooking(day)"
            >
              <div class="text-[10px] uppercase font-bold text-slate-400">
                {{ day | date: 'EEEE' }}
              </div>
              <div class="text-lg font-black text-slate-700">
                {{ day | date: 'dd' }}
              </div>
            </div>
          }
        </div>

        <!-- Grid -->
        <div class="flex relative h-[1000px]">
          <!-- Time Axis -->
          <div class="w-20 border-r border-gray-100 bg-slate-50/30">
            @for (hour of timeSlots; track hour) {
              <div class="h-[71.4px] text-[11px] font-bold text-slate-400 text-right pr-3">
                {{ hour }}:00
              </div>
            }
          </div>

          <!-- Days -->
          <div class="flex flex-1">
            @for (day of weekDays(); track day.getTime()) {
              <div class="flex-1 border-r border-gray-50 relative group/day">
                <!-- Empty Slots (Clickable) -->
                @for (hour of timeSlots; track hour) {
                  <div
                    class="absolute w-full border-b border-gray-100 h-[71.4px] hover:bg-emerald-50/50 cursor-pointer transition-colors z-10"
                    [style.top.%]="(($index * 60) / (14 * 60)) * 100"
                    (click)="openModal(day, hour + ':00')"
                  >
                    <div
                      class="absolute inset-0 flex items-center justify-center text-emerald-400 font-bold opacity-30 pointer-events-none"
                    >
                      +
                    </div>
                  </div>
                }

                <!-- Bookings -->
                @for (b of getPositionedBookings(day); track b.id) {
                  <div
                    class="absolute rounded-xl p-2 text-white shadow-md border border-white/20 transition-all hover:scale-[1.02] z-20 hover:z-40 cursor-pointer overflow-hidden"
                    [class]="
                      b.createdBy === currentUser()?.uid
                        ? 'bg-emerald-500'
                        : 'bg-rose-400 opacity-90'
                    "
                    [style.top]="getBookingStyle(b).top"
                    [style.height]="getBookingStyle(b).height"
                    [style.left]="getBookingStyle(b).left"
                    [style.width]="getBookingStyle(b).width"
                    (click)="$event.stopPropagation(); editBooking(b)"
                  >
                    <div class="text-[9px] font-black uppercase opacity-70 truncate">
                      {{ getRoomName(b.roomId) }}
                    </div>
                    <div class="text-[11px] font-bold leading-tight">{{ b.title }}</div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </main>
}

<!-- MODAL (Adapted from Bookings) -->
@if (showModal()) {
  <app-booking-modal
    [rooms]="rooms()"
    [currentUser]="currentUser()"
    [isAdmin]="isAdmin()"
    [booking]="selectedBooking()"
    [prefillData]="newBookingData()"
    (close)="closeModal()"
    (saved)="onBookingSaved()"
  >
  </app-booking-modal>
}
